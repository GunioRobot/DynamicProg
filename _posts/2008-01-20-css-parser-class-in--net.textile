---
layout: post
title: CSS parser class in .NET.
summary: We are changing our template system at work and my boss ask me to look around for a css parser class. The class needed to load a bunch of css files and parse them to be able to get a value from an attribute of a given key.
categories: [Programming, .Net]
---

We are changing our template system at work and my boss ask me to look around for a css parser class. The class needed to load a bunch of css files and parse them to be able to get a value from an attribute of a given key. The class needs to be "inteligent" enough to apply some precedence rules so the latest css file will override or augment the previous ones. After doing a quick search in google I couldn't find something that could help us, we needed something simpler with little overheat, so it was time to write my own.
        
So I went to the task and came up with this: 
It seems to work well enough, it's a very simple implementation, there is no validation for valid formatting and is quite permissive with the quality of your css, so it should parse well your file even if the formatting is not 100% correct.

The algorithm is very naive, but I didn't find any major problems with it. The only issue that I see on this one is that the famous hack for IE (using the * selector) will be ignored and that style may be removed, but you shouldn't be hacking your css, should you? (irony there).

{% highlight cs %}
	using System; 
	using System.IO; 
	using System.Collections.Generic; 
	using System.Text; 
	using System.Text.RegularExpressions;
	
	namespace LaTrompa.Web
	{
		public class CssParser
		{
			private List<string> _styleSheets;
			private SortedList<string,StyleClass> _scc;
			public SortedList<string,StyleClass> Styles 
			{
				get { return this._scc; }
				set { this._scc = value; }
			}
		
			public CssParser()
			{
				this._styleSheets = new List<string>();
				this._scc = new SortedList<string, StyleClass>();
			}
			
			public void AddStyleSheet(string path)
			{
				this._styleSheets.Add(path);
				ProcessStyleSheet(path);
			}
			
			public string GetStyleSheet(int index)
			{
				return this._styleSheets[index];
			}
			
			private void ProcessStyleSheet(string path)
			{
				string content = CleanUp(File.ReadAllText(path));
				string[] parts = content.Split('}');
				foreach (string s in parts)
				{
					if (CleanUp(s).IndexOf('{') > -1)
					{
						FillStyleClass(s);
					}
				}
			}
		
			private void FillStyleClass(string s)
			{
				StyleClass sc = null;
				string[] parts = s.Split('{');
				string styleName = CleanUp(parts[0]).Trim().ToLower();
				
				if (this._scc.ContainsKey(styleName))
				{
					sc = this._scc[styleName];
					this._scc.Remove(styleName);
				}
				else
				{
					sc = new StyleClass();
				}
				
				sc.Name = styleName;
				
				string[] atrs = CleanUp(parts[1]).Replace("}","").Split(';');
				foreach (string a in atrs)
				{
					if (a.Contains(":"))
					{
						string _key = a.Split(':')[0].Trim().ToLower();
						if (sc.Attributes.ContainsKey(_key))
						{
							sc.Attributes.Remove(_key);
						}
						sc.Attributes.Add(_key, a.Split(':')[1].Trim().ToLower());
					}
				}
				this._scc.Add(sc.Name, sc);
			}
		
			private string CleanUp(string s)
			{
				string temp = s;
				string reg = "(/\\*(.|[\r\n])*?\\*/)|(//.*)";
				Regex r = new Regex(reg);
				temp = r.Replace(temp,"");
				temp = temp.Replace("\r", "").Replace("\n", "");
				return temp;
			}
		
			public class StyleClass
			{
				private string _name = string.Empty;
				public string Name
				{
					get { return _name; }
					set { _name = value; }
				}
				
				private SortedList<string, string> _attributes =  new SortedList<string,string>();
				public SortedList<string, string> Attributes
				{
					get { return _attributes; }
					set { _attributes = value; }
				}         
			}
		} 
	} 
{% endhighlight %}
        
Some other solutions and articles related.

<a href="http://ostermiller.org/findcomment.html">RegEx to find C style comments.</a> <a href="http://www.devincook.com/goldparser/engine/c-sharp/index.htm">http://www.kinlan.co.uk/2006/01/google-search-c-css-parser.html Css Parser Gold Parser</a>